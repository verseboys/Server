{% extends 'header_base.html' %}
{% load static %}

{% block titleblock %}{{ title }}-医咖会{% endblock titleblock %}
{% block headblock %}
    <link rel="stylesheet" href="{% static 'css/video.css' %}">
{% endblock headblock %}
{% block head_description %}
    {{ course_main }}
{% endblock head_description %}

{% block bodyblock %}
    <div style="background-color:#595959">
        <div class="button_container_video">
            <div class="button_center_container">
                <div class="video_group_title">
                    {{ title }}
                </div>
                <div class="collect_button" data-collect-id="{{ collect_category_id }}">
                    <!-- class="hide" 判定是否已收藏渲染 -->
                <img src="{% static 'images/star_gray.png' %}"class="star_gray{% if is_collect %} hide {% endif %}">
                <img src="{% static 'images/star_yellow.png' %}" class="star_light  {% if not is_collect %} hide {% endif %}" >
                </div>

                <!-- 免费时渲染 -->
                {% if not is_pay %}
                    <div class="free_button">
                        免费
                    </div>
                {% else %}
                <!-- 收费 -->
                    {% if is_buy %}
                        <div class="pay_button">
                            已购
                        </div>
                    {% else %}
                        <div class="pay_button charge" data-id="{{ video_id }}">
                            购买
                        </div>
                    {% endif %}
                {% endif %}

            </div>
        </div>
        <div class="video_container" style="max-width:1200px">
            <div class="video_center_container">
                <div class="video_list_container" >
                    <div id="player" class="video_player"></div>
                        <div class="video_list_button"  >
                            <span class="video_list_button_menu">
                                目录<img width="12" style="position:relative;left:2px;" src="{% static 'images/arrow.png' %}">
                            </span>
                        </div>
                        <div class="play_button">
                            <img src="{% static 'images/video_play.png' %}" style=" border-radius: 50%">
                        </div>
                        <!-- TODO：未登录提示 -->
                        <!-- <div class="video_reject" style="display:none">
                            <img src="{% static 'images/video_play.png' %}"  width="100%" height="100%">
                            <div class="go_login">
                                去登录
                            </div>
                        </div> -->
                    <div id="video_list_container" class="video_list">
                        <div id="div1">
                            <div class="study_list"><span class="study_list_content">课程目录</span></div>
                            <div class="study_list_line"></div>
                            {% for c in course_section %}
                                <div >
                                    <div class="video_list_item">
                                        <div class="video_list_item_title">
                                            <!-- class="video_group_negative" 不是当前课程渲染-->
                                            {% if c.course_id != course_id %}
                                            <img width="19" height="21" src="{% static 'images/group_negative.png' %}" style="margin-right:10px;margin-top:5px" class="video_group_negative"><span style="position:relative;top:-3px;" class="video_group_negative">{{ c.course }}</span>
                                            {% else %}
                                            <img width="19" height="21" src="{% static 'images/group_negative.png' %}" style="margin-right:10px;margin-top:5px" class="video_group_negative">
                                            <span style="position:relative;top:-3px;">{{ c.course }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <!-- class="video_list_active" 当前课时渲染 -->
                                    {% for v in c.video_list %}
                                        {% if v.is_pay != 2 %}
                                            <a href="{% url 'video_detail' video_id=v.video_id %}" target="_blank">
                                                <div class="video_list_item_content {% if v.video_id == video_id %}video_list_active{% endif %}">{{ forloop.counter }}.&nbsp;{{ v.title }}</div>
                                            </a>
                                        {% else %}
                                            <div class="video_list_item_content">{{ forloop.counter }}.&nbsp;{{ v.title }}</div>
                                        {% endif %}

                                    {% endfor %}
                                </div>
                            {% endfor %}

                        </div>
                        <div id="div2">
                            <div id="div3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pc-state-box" class="hide">
            <div class="hide">{{ check_typ }}</div>
            <div id="neko_shadow_box" v-show="check_type">
                <div class="close_btn" @click="close()"></div>
                <pc-state-box v-bind:check_type="check_type"></pc-state-box>
                <pc-collect-add v-bind:check_type="check_type" v-bind:old="old_check"></pc-collect-add>
                <pc-collect-chage v-bind:check_type="check_type" v-bind:old="old_check" v-bind:val="change_collect_val"></pc-collect-chage>
                <pc-collect-list v-bind:check_type="check_type" v-bind:old="old_check" v-bind:lists="collect_lists" v-bind:user="user" :video="true" ></pc-collect-list>
            </div>
        </div>
    </div>
    <!-- 服务器渲染部分 -->
    <div style="width:100%;background-color: #f9f9f9;margin-bottom:-15px">
        <div class="items_container">
            <div class="main_container">
                <div class="title_container">
                    <div class="point_title title_active">
                        本期要点
                    </div>
                    <div class="study_list_title">
                        课程目录
                    </div>
                    <div class="introduce_title">
                        讲者介绍
                    </div>
                    <div class="comment_title">
                        评论
                    </div>
                    <div class="download_title">
                        资料下载
                    </div>
                </div>
                <div class="point_container">
                    <!-- 本期要点 -->
                    <div class="point_container_for_target_video" data-vid="123" >
{#                              <div class="point_list_title">一、本节要点</div>#}
                        {{ course_main|safe }}
                    </div>
                </div>
                <div class="study_list_container" style="display:none">
                    {% if course_section %}
                        {% for c in course_section %}

                            <!-- 课程目录 -->
                            <div class="video_group_block">
                                <div class="video_group_block_title"> <div style="display:inline-block;width:28px;height:18px;position:relative;top:2px;"><img  height="18" src="{% static 'images/group_active.png'%}"></div>{{ c.course }}</div>
                                {% if c.video_list %}
                                    {% for v in c.video_list %}
                                        {% if v.is_pay != 2 %}
                                            <a href="{% url 'video_detail' video_id=v.video_id %}" target="_blank">
                                                <div class="video_block">
                                                    <!-- 课程名称 -->
                                                    <div class="video_title">
                                                        {{ forloop.counter }}.{{ v.title }}
                                                    </div>
                                                    <!-- 课程时长 -->
                                                    <div class="video_time">
                                                        {% if v.video_time %}
                                                            <img width="17" height="17" style="position:absolute;top:5px;left:0px;border-radius: 50%;" src="{% static 'images/video_time.png' %}"> <span style="position:relative;left:5px">{{ v.video_time }}</span>
                                                        {% endif %}
                                                    </div>
                                                    <!-- 课程状态 付费-->
                                                    {% if v.is_pay == 0 %}
                                                        <div class="video_free">免费</div>
                                                    {% elif v.is_pay == 1 %}
                                                        <div class="video_state video_ready" style="display:none">付费课程</div>
                                                    {% else %}
                                                        <div class="video_state video_comming" style="display:none">更新中</div>
                                                    {% endif %}
                                                </div>
                                            </a>
                                            {% else %}

                                                <div class="video_block">
                                                    <!-- 课程名称 -->
                                                    <div class="video_title">
                                                        {{ forloop.counter }}.{{ v.title }}
                                                    </div>
                                                    <!-- 课程时长 -->
                                                    <div class="video_time">
                                                        {% if v.video_time %}
                                                            <img width="17" height="17" style="position:absolute;top:5px;left:0px" src="{% static 'images/video_time.png' %}"> <span style="position:relative;left:5px">{{ v.video_time }}</span>
                                                        {% endif %}
                                                    </div>
                                                    <!-- 课程状态 付费-->
                                                    {% if v.is_pay == 0 %}
                                                        <div class="video_free">免费</div>
                                                    {% elif v.is_pay == 1 %}
                                                        <div class="video_state video_ready" style="display:none">付费课程</div>
                                                    {% else %}
                                                        <div class="video_state video_comming" style="display:none">更新中</div>
                                                    {% endif %}
                                                </div>

                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <!-- 这里在每个视频组后面多渲染个高度10px的div不然间距不好调 -->
                            <div style="height:10px;"></div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="introduce_container" style="display:none">
                    <!-- 复文本编辑 -->
                    <div class="introduce_content">
                        {{ teach_intro|safe }}<br/>
                    </div>
                </div>
                <div class="comment_container" style="display:none">

                </div>
                <div class="download_container" style="display:none">
                   {% if video_related_data %}
                    {% for v in video_related_data %}
                        <div class="file_container">
                    <span class="file_name">
                           {{ v.file_name }}
                    </span>
                    <span class="download_button">
                        {% if front_user %}
                            <a class="user_download" data-href="{% url 'front_download_article' article_id=video_id type_id=3 file_id=v.file_id %}" style="color:#fff;position:relative;top:1px;" onclick="let t=$(this);if(document.cookie==''){t[0].href='http://'+t[0].host+'/login/?next='+location.pathname+'#1';return }">
                                <div class="down_load_button_flag" style="height:25px;line-height:25px;cursor:pointer">下载</div>
                            </a>
                            {% else %}
                            <a href="javascript:( window.location.href = '/login/?next=' + window.location.pathname+'#1')" style="color:#fff;position:relative;top:1px;">下载</a>
                        {% endif %}
                    </span>
                        </div>
                    {% endfor %}
                   {% endif %}

                </div>

            </div>
            <div class="two_d_code_container">
                <img src="{% static 'images/erweima1.png' %}" width="105" height="105" class="two_d_code">
                <div class="two_d_code_message">
                    <img src="{% static 'images/bitmap-copy-2@3x.png' %}">
                </div>
            </div>
        </div>
        
        <!--收费弹窗-->
        <!-- 后台渲染 -->
        <div class="bill_background hide">
            <div class="bill_container">
                <div class="bill_container_cancel">
                    <img src="{% static 'images/cancel.png' %}" >
                </div>
                <div class="course_img_container">
                    <img src="/images/article_images/{{ course_thumbnail }}" style="border-radius: 2px; width:262px;height:151px" >
                </div>
                <div class="course_title">
                    Stata教程-从入门到精通
                </div>
                <div class="readme_container">
                    <div class="checkbox_container">
                        <img class="checkbox_cancel hide" src="https://cdn.zeplin.io/59a37c1e1d67d1f72d98c3f3/assets/3E993461-BD2C-4C7B-B6D9-34EC6782E8E4.png">
                        <img class="checkbox_confirm " src="{% static 'images/checkbox_active.png' %}">
                    </div>  
                    <span>我已经阅读并同意 <span class="readme_show">《医咖会服务协议》</span></span>                 
                </div>
                <div class="price_container">
                    <span class="price_old">￥&nbsp;299.0</span>
                    <span class="price_new">￥&nbsp;{{ price }}</span>
                </div>
                <div class="bill_cancel">
                    取消
                </div>
                <div class="bill_confirm">
                    提交订单
                </div>
            </div>
            <div class="readme hide">
                <div>
                    <div class="readme_cancel">
                            <img src="{% static 'images/cancel.png' %}" >
                    </div>
                </div>
                <h3 class="readme_title">
                        医咖会服务协议
                </h3>
                <pre class="readme_comtent">    欢迎使用医咖会服务，为保障用户权益，请用户在付费之前，详细阅读此服务协议（以下简称“本协议”）所有内容，特别是加粗部分。当用户点选“【我已经阅读并同意《医咖会服务协议》】”时，即表示用户同意并承诺遵守本协议。
    本协议内容包括协议正文、医咖会已经发布的或将来可能发布的各类规则。所有规则为本协议不可分割的组成部分，与协议正文具有同等法律效力。
    如果您未满18周岁，请在法定监护人的陪同下阅读本协议，并在法定监护人的指导下使用本服务。
 
【第一条 定义】
1. 医咖会：医咖会品牌和商标为北京医助科技有限公司所有，www.mediecogroup.com为医咖会的经营平台。医咖会声明其所展示并销售的课程（含视频、图片及文章等）的著作权均属于医咖会或供图作者所有，受中华人民共和国知识产权法以及其他法律规定的保护。
2. 协议范围：本协议是您（以下也称“用户”）、医咖会或供图作者等之间关于您使用本服务所涉相关事项的法律协议。
3. 收费课程是指医咖会有偿提供给用户的视频、资料、图片等内容。
 
【第二条 本协议的修订】
医咖会有权对本协议进行调整或补充，并在医咖会平台公告。若用户继续使用医咖会服务，则视为接受该等调整或补充，亦或用户有权终止使用该服务。
 
【第三条 医咖会服务规范】
1. 医咖会作为课程提供方，为用户提供观看课程平台服务。医咖会平台可以为用户提供有偿服务或内容（包括但不限于收费课程等所有收费类型的服务和内容，下同），医咖会为有偿服务或内容的提供方或售卖方。
2. 除非另有证明，医咖会储存在其服务器上的数据是用户使用医咖会服务的唯一有效证据。

【第四条 用户规则】
1. 用户可在医咖会平台上浏览医咖会提供的内容，如用户希望有偿获得该部分内容或服务，则用户需先登录或注册医咖会帐号。
2. 您确认：您是具备完全民事权利能力和完全民事行为能力的自然人、法人或其他组织，有能力对您使用医咖会服务的一切行为独立承担责任。若您不具备前述主体资格，医咖会在依据法律规定或本协议约定要求您承担责任时，有权向您的监护人追偿。
3. 用户理解并同意，医咖会平台提供有偿内容或服务实行先付款后使用的方式，用户及时、足额、合法的支付所需的款项是您使用该等有偿内容或服务的前提。
4. 用户理解并同意，录播视频课程通过医咖会平台发布的收费课程将采用整体购买的方式，即用户只需购买一次，就可以学习该课程所有已发布或即将发布的课时。已购买的收费录播视频课程，用户可以自己重复学习，无需再次付费，暂无观看时间限制（后续如有变化另行通知）。
5. 用户理解并同意，用户无权对已购买的课程进行出售、转让、许可或其他方式使除用户自己以外的第三方（包括但不限于自然人、法人或其他组织）使用其已购买的课程。若用户违反本条规定，则医咖会有权视情况采取如下措施：
1) 取消用户继续使用该课程的权利；
2) 限制/冻结用户的帐号；
3) 要求用户退还其通过出售、转让、许可等其他方式取得的收益；
4) 其他医咖会可以采取的救济措施（包括但不限于向您或第三方追究侵权责任）；
6. 用户了解并同意，医咖会可能会基于自身原因（包括但不限于：更新课程内容、改进课程安排）不定期的对收费课程进行更新而无需经过您的事先同意。
7. 用户应保管好自己的帐号和密码，如因用户未保管好自己的帐号和密码而对自己、医咖会或第三方造成损害的，用户将负全部责任。另外，用户应对用户帐号中的所有活动和事件负全责。用户可随时改变帐号绑定信息和密码。用户同意若发现有非法使用用户的帐号或出现安全漏洞的情况，立即通告医咖会，将会尽力予以妥善解决。
 
【第五条 退款规则】
A. 用户购买课程之日起7天内，因医咖会平台技术原因可申请退款。技术原因是指：由医咖会平台技术故障引发的连续超过24小时课程无法正常观看、视频无法正常播放、PPT/PDF课程无法观看。非医咖会平台技术原因不予退款，如用户个人网络原因、观看设备故障、用户账号丢失等类原因不属于平台技术故障。
B. 用户购买超过7天后一律不予退款。
 
【第六条 其他规则】
1. 不可抗力：医咖会对不可抗力导致的损失不承担责任。本服务条款所指不可抗力包括：天灾、法律法规或政府指令的变更，因网络服务特性而特有的原因，例如境内外基础电信运营商的故障、计算机或互联网相关技术缺陷、互联网覆盖范围限制、计算机病毒、黑客攻击等因素，及其他合法范围内的不能预见、不能避免并不能克服的客观情况。
2. 服务中止、中断及终止：医咖会根据自身商业决策等原因可能会选择中止、中断及中止平台服务。如有此等情形发生，医咖会会采取公告的形式通知您。经国家行政或司法机关的生效法律文书确认您存在违法或侵权行为，或者医咖会根据自身的判断，认为您的行为涉嫌违反本协议内容或医咖会不时公布的使用规则等内容，或涉嫌违反法律法规的规定的，则医咖会有权中止、中断或终止向您提供服务，且无须为此向您或任何第三方承担责任。
3. 所有权及知识产权：医咖会平台上所有内容，包括但不限于课程、文字、声音、图片、软件、图表、网站架构、网站画面的安排、网页设计、以及有偿内容或服务均由医咖会、供图作者或其他权利人依法拥有其知识产权，包括但不限于著作权、商标权、专利权等。非经医咖会书面同意用户不得擅自使用、修改、复制、传播、改变、散布、发行或发表上述内容。如有违反，用户同意承担由此给医咖会、供图作者或其他权利人造成的一切损失，同时保留追究用户侵权责任的权利。
4. 所有发给用户的通知都可通过电子邮件、常规的信件或在网站显著位置公告的方式进行传送。
5. 本协议适用中华人民共和国的法律。当本协议的任何内容与中华人民共和国法律相抵触时，应当以法律规定为准，同时相关内容将按法律规定进行修改或重新解释，而本协议其他部分的法律效力不变。
6. 本协议自发布之日起实施，并构成用户和医咖会之间的共识。
7. 医咖会不行使、未能及时行使或者未充分行使本协议或者按照法律规定所享有的权利，不应被视为放弃该权利，也不影响医咖会在将来行使该权利。
8. 如果用户对本协议内容有任何疑问，请发送邮件至我们的客服邮箱：http://yikahui@mediecogroup.com
9. 本协议于2018年5月20日生效。
                </pre>
            </div>
        </div>

    </div>
    <script type="text/javascript" src="{% static 'js/user_download.js' %}"></script>
    <script src='https://player.polyv.net/script/polyvplayer.min.js'></script>
    <div id='previewArea'></div>
    <script>
        //屏幕适配
       let screenwid= window.innerWidth>=1278? window.innerWidth:1278
        let sizeParam=Math.sqrt(screenwid/1885)
        let fitScreen=function(){
            $(".button_center_container").width(1155* sizeParam+"px")
            $(".button_container_video").width(1200* sizeParam<=1200?1200:1200* sizeParam+"px")
            $(".video_list_container").width(1155* sizeParam+"px").height(512* sizeParam+"px")
            $(".video_center_container").width(1155* sizeParam+"px").height(512* sizeParam+"px")
            $(".video_container").height(512* sizeParam+"px")    
            $("#video_list_container").height(512* sizeParam+"px") 
            $("#div2").height(512* sizeParam+"px") 
            $(".video_list_container .video_list_button").css('top',200* sizeParam+"px")
        }
        fitScreen()
        let reg = new RegExp("[<>]", 'ig')
        //播放页面逻辑
        var player = polyvObject('#player').videoPlayer({
            'width': 1155*sizeParam,
            'height': 512*sizeParam,
            'vid': '{{ code }}',
            'code': '{{ request.front_user.id }}',
            'flashvars': {'ban_skin_big_play_btn': "on"}
        });
        //'loading_bg_img':''
        //自定义播放按钮

        let video_play_button = $(".play_button")

        video_play_button.click(function () {
            player.j2s_resumeVideo();
            video_play_button.hide()
        })
        window.s2j_onVideoPause = function () {
            video_play_button.show()
        }
        window.s2j_onPlayerError = function (e) {
            if (e == '__onVerificationBan') {
                video_play_button.hide()
                //$(".video_reject").show()
                // video_play_button.unbind('click').click(function(){
                //     location.replace('/login/?next=/#1')
                // })

            }
        }
        window.s2j_onVideoPlay = function () {
            video_play_button.hide()
        }

        var box = new Vue({
            el: '#pc-state-box',
            data: {
                check_type: 0,
                fix_wat: {
                    show: 'show neko_shadow_box',
                    hide: 'neko_shadow_box hide'
                },
                old_check: 0,
                collect_lists: [],
                user: {
                    ques_id: '1',
                    ans_id: '2',
                    tar: ''
                },
                item: 0,
                del_item: '',
                change_collect_val: {}
            },
            methods: {
                open:function () {
                    $.ajax({
                        url: '/user_collect_category_list/',
                        type: 'get',
                        success: function (data) {
                            console.log(1122,data)
                            if (data.code === 200) {
                                box.collect_lists = data.data.user_collect_category_list;
                                //box.user.ans_id = ans
                                check_type(7);
                            } else if (data.code == 302) {
                                //跳转至登录页
                                location.replace('/login/?next=/#1')
                            } else if(data.code==400){
                                box.collect_lists=[]
                                check_type(7);
                            }else {
                                return
                            }
                        }
                    })

                },
                close: function () {
                    this.check_type = 0
                },
                check_old: function (num) {
                    this.old_check = num;
                    this.check_type = 6
                },
                del_collect_list: function (list, num) {
                    this.del_item = list.id
                    this.item = num
                    this.check_type = 22;
                },
                cancel_collect_list: function () {
                    this.check_type = 21
                },
                push_del_collect: function () {
                    $.ajax({
                        url: '/delete_collect_category/' + this.del_item + '/',
                        type: 'get',
                        success: function (data) {

                            $.ajax({
                                url: '/user_collect_category_list/',
                                type: 'get',
                                success: function (data) {
                                    if (data.code == 200) {
                                        var list = data.data.user_collect_category_list
                                        box.collect_lists = list;
                                    }
                                }
                            })
                        }
                    })

                    this.check_type = 21;
                },
                change_collect_list: function (list, item) {
                    var self = this
                    $.ajax({
                        url: '/alter_collect_category/' + list.id + '/',
                        type: 'get',
                        siccess: function (data) {
                            self.change_collect_val = data.data;
                            check_type(23)
                        }
                    })
                }
            },
            computed: {
                check_typ: function () {
                    this.check_type === 0 ? $('#pc-state-box').addClass('hide') : $('#pc-state-box').removeClass('hide');
                }
            }
        });
        //开关收藏栏
        $(".collect_button").click(function () {
            let t =$(this)
            if(t.find(".hide").hasClass('star_light')){
                box.open()
            }else {
                $.ajax({
                    url: "/front_favorites/" + video_id + "/" +t.data().collectId+ "/3/",
                    type: "get",
                    success: function (data) {
                        if (data.data.is_collect == 0) {
                            $('.star_light').addClass("hide")
                            $('.star_gray').removeClass("hide")
                        }
                    }
                })
            }

        })


        //点赞逻辑
        //预加载已点赞图片
        let like_active_promise=new Promise(function(resolve){
            let like_active=new Image(13,17)
            like_active.src="{% static 'images/like_active.png' %}"
            like_active.onload=function(){
                resolve(like_active)
            }
        })
        //预加载未点赞图片
        let like_negative_promise = new Promise(function (resolve) {
            let like_negative = new Image(13, 17)
            like_negative.src = "http://localhost:8000/static/images/like_negative.png"
            like_negative.onload = function () {
                resolve(like_negative)
            }
        })
        //获取当前页面的video_id
        let video_id = {{ video_id }}
        let commentContainer = $(".comment_container")
        let unloginContent = `
            <div class="new_comment_container_disable" >
                <div class="fake_input_place">
                    　输入评论...
                </div>

                <div class="login_place">
                    <img src="{% static 'images/warning.png'%}" width="16px" style="position: relative;top:2px;">
                    你尚未登录，请 <a href="/login/?next=/#1" style="color:#3d83df;;text-decoration:underline">登录</a> 后评论
                </div>
            </div> `
        //需要模板渲染
        let loginContent = `
            <div class="new_comment_container">
                <textarea id="user_input" cols="30" rows="10" class="real_input_place" placeholder="&nbsp输入评论..."></textarea>
                <div class="login_button" data-video-id="{{video_id}}">
                    发表评论
                </div>
            </div>`

        let commentContent = function (user_avatar, user_name, comment_content, comment_time, response_list, like_number, comment_id, is_active) {
            /*
             user_avatar  用户头像路径
             user_name    用户名称
             comment_content 评论内容
             comment_time    评论时间
             response_list   回复列表
             like_number     点赞数
             comment_id      评论id
             */
            //    头像路径需要更改
            let head = `
                    <div class="comment_content_title">
                        <!-- 评论者头像 -->
                    <div class="comment_avatar">
                    <img  src="/images/avatar/${user_avatar}" style="width: 45px;height: 45px;border-radius: 50%; ">
                    </div>
                    <span class="comment_name">${user_name}</span>
                    <span class="comment_time">${comment_time}</span>
                    </div>
                    <div class="comment_body">
                        ${comment_content.replace(reg,"")}
                    </div>`

            let body=""
            if(response_list.length!=0){
                let response=``
                for(var a in response_list.reverse()){
                    //回复内容
                    response+=
            `
                    <div class="comment_response">
                    <span class="response_name">
                    ${response_list[a].username}
                    </span>
                    <span class="response_response">:</span>
                    <span class="response_words">${response_list[a].comment}</span>
                    </div>`

                }
                body=
            `
                    <div class="response_container">
                    ${response}
                    </div>
                    `

            }

            let foot=
            `<div class="response_like">
                    <div class="response_response_inner">
                    <span class="response_trigger" style="cursor: pointer;" >回复 </span>
                    </div>
                    <div class="response_like_inner" data-response-id="${comment_id}">
                    <img class="like_img" data-active="false" style="position:relative;top:2px;display:${is_active==0?"inline-block":"none"}" src="{% static 'images/like_negative.png'%}">
                    <img class="like_img" data-active="true" style="position:relative;top:2px;display:${is_active==0?"none":"inline-block"}" src="{% static 'images/like_active.png'%}"><span class="response_like_number" style="position:absolute;left:950px">${like_number}</span>
                    </div>
                    </div>
                    <div class="response_tool tool_hide">
                    <input type="text" class="response_input" placeholder="输入回复...">
                    <!--  data-response-id 为唯一标识 -->
                    <div class="response_button" data-response-id="${comment_id}">回复</div></div>`

            return`<div class="comment_content">
                        ${head}${body}${foot}
                    </div>`

        }
        let noComment=
            `<div class="empty_comment">
                    <div class="empty_img">
                    <img width="49" style="margin-left:19px;margin-bottom:15px" src="{% static 'images/empty_comment.png'%}"><br>
                    目前暂无评论！
                    </div></div>`

        //加载中状态
        //commentContainer.html(unloginContent+commentContent('',"哈哈","321213123","5分钟前",[],100,123,0)+commentContent('',"哈哈","3213213123","1天前",[],100,123,1))
        //判定是否登录
        //TODO:后台模板修改

        if({{ front_user.id|default:0 }}){
            commonContent=loginContent;
        }else{
            commonContent=unloginContent;
        };

        let page_local=1
        let compileComment=function(page){
            $.ajax({
                url:"/video_comment/"+video_id+"/"+page+"/",
                type:"get",
                success:function(data){
                    //判定是否登录
                    //TODO:后台模板修改
                    if({{ front_user.id|default:0 }}){
                        commonContent=loginContent;
                    }else{
                         commonContent=unloginContent;
                    }

                    page_local=data.data.current_page
                    if(data.code!=200){
                        commentContainer.html(commonContent+noComment)
                    }else{
                        for(var a of data.data.comment_list){
                            commonContent+=commentContent(a.avatar,a.username,a.comment,a.create_time,a.relevance_comment,a.praise_count,a.id,a.is_praise)
                        }
                    let page_count=data.data.page_count
                    let pageManager=null
                    if(page_count<5){
                        pageManager=

            `<div class="text-cen">
                    <ul class="pagination—list">
                    <li class="prev" style="display:${page>1?"default":"none"}"><a rel="prev" href="">上一页</a></li>
                    <li class="${page==1?"active":""}"  style="display:${page_count>1?"default":"none"}"><a href="">1</a></li>
                    <li class="${page==2?"active":""}"><a href="" style="display:${page_count>=2?"default":"none"}">2</a></li>
                    <li class="${page==3?"active":""}"><a href=""  style="display:${page_count>=3?"default":"none"}">3</a></li>
                    <li class="${page==4?"active":""}"><a href=""  style="display:${page_count>=4?"default":"none"}">4</a></li>
                    <li class="next"><a rel="next" href="" style="display:${page<page_count?"default":"none"}">下一页</a></li>
                    </ul>
                    </div>`


                    }else{
                        pageManager=

            `<div class="text-cen">
                    <ul class="pagination—list">
                    <li class="prev" style="display:${page>1?"default":"none"}"><a rel="prev" href="">上一页</a></li>
                    <li class="${page==1?"active":""}"><a href="">1</a></li>
                    <li class="disabled" style="display:${page>3&&page_count>5?"default":"none"}"><span>…</span></li>
                    <li class="${(page<4&&page==2)?"active":""}"><a href="">${page<4?2:page>=page_count-1?page_count-3:page-1}</a></li>
                    <li class="${(page<4&&page==3)||(page>=4&&page!=1&&page!=page_count&&page!=page_count-1)?"active":""}"><a href="">${page<4?3:page>=page_count-1?page_count-2:page}</a></li>
                    <li class="${(page>=page_count-1)&&(page==page_count-1)?"active":""}"><a href="">${page<4?4:page>=page_count-1?page_count-1:page+1}</a></li>
                    <li class="disabled"  style="display:${(page_count-page>2)&&page_count>5?"default":"none"}"><span>…</span></li>
                    <li class="${page==page_count?"active":""}"><a href="">${page_count}</a></li>
                    <li class="next" ><a rel="next" href="" style="display:${page<page_count?"default":"none"}">下一页</a></li>
                    </ul>
                    </div>`

                    }
                        commentContainer.html(commonContent+pageManager)
                        //分页逻辑
                        let button_list=$('.pagination—list').find("a")
                        button_list.click(function(e){
                            button_list.unbind("click")
                            e.preventDefault()
                            let t=$(e.target)
                            if(t.html()=="下一页"){
                                compileComment(++page_local)
                            }else if(t.html()=="上一页"){
                                compileComment(--page_local)
                            }else{
                                compileComment(+t.html())
                            }
                        })
                        //绑定回复开关事件
                        $(".response_trigger").click(function(){
                            $(this).parent().parent().siblings(".response_tool").removeClass("tool_hide")
                        })
                        //回复事件
                        $(".response_button").click(function(){
                            let t =$(this)
                            let inputValue=t.siblings("input").val()
                            if(inputValue.trim()==""){
                                t.siblings("input").attr({"placeholder":"回复内容不能为空哦"})
                            }else{
                                let response=new FormData()
                                t.html("回复中···").attr("disabled")
                                response.append("relevance_comment_id",t.data().responseId)
                                response.append("comment",inputValue)
                                //带上video_id
                                response.append("video_id",video_id)
                                $.ajax({
                                    url:"/add_video_comment/",
                                    type:"POST",
                                    data:response,
                                    contentType:false,
                                    processData:false,
                                    success:function(data){
                                        if(data.code==302){
                                            //跳转登录页面
                                            location.replace('/login/?next=/#1')
                                        }else if(data.code==200){
                                            t.html("回复")
                                            t.siblings("input").val("")
                                            compileComment(page)
                                        }else{
                                            //网络链接失败
                                        }
                                    },
                                    error:function(){
                                        t.html("回复失败")
                                    }
                                })
                            }
                        })
                        //点赞逻辑
                        $(".response_like_inner").click(function(e){
                            let t=$(e.target)
                            if(t.hasClass("like_img")){
                                let comment_id=$(this).data().responseId
                                //登录状态验证
                                //是否已经点过赞验证
                                if(t.data().active){
                                    //已经点过赞了
                                    //变为取消点赞
                                    like_negative_promise.then((img)=>{
                                        $.ajax({
                                            url:"/praise/"+comment_id+"/6/",
                                            type:"get",
                                            success:function(data){
                                                if(data.code==302){
                                                    //跳转至登录页
                                                    location.replace('/login/?next=/#1')
                                                }else if(data.code==200){
                                                    t.siblings("span").html(+t.siblings("span").html()-1)
                                                    let newImg=img.cloneNode(true)
                                                    $(newImg).addClass("like_img").data({active:false})
                                                    t.replaceWith(newImg)
                                                }else{
                                                    //其他错误
                                                    return
                                                }
                                            },
                                            error:function(e){
                                                //网络错误
                                                console.log(e)
                                            }
                                        })
                                    })
                                }else{
                                    //更换点赞图片点赞数加1
                                    like_active_promise.then((img)=>{
                                        $.ajax({
                                            url:"/praise/"+comment_id+"/6/",
                                            type:"get",
                                            success:function(data){
                                                if(data.code==302){
                                                    //跳转至登录页
                                                    location.replace('/login/?next=/#1')
                                                }else if(data.code==200){
                                                    t.siblings("span").html(+t.siblings("span").html()+1)
                                                    let newImg=img.cloneNode(true)
                                                    $(newImg).addClass("like_img").data({active:true})
                                                    t.replaceWith(newImg)
                                                }else{
                                                    //其他错误
                                                    return
                                                }
                                            },
                                            error:function(e){
                                                //网络错误
                                                console.log(e)
                                            }
                                        })
                                    })
                                }
                            }else{
                                return
                            }
                        })
                    }
                    //绑定发表评论事件
                    //limit
                    $(".login_button").click(function(){
                        let t=$(this)
                        let response=new FormData()
                        let comment_place=t.siblings("textarea")
                        let comment_content=t.siblings("textarea").val()
                        if(comment_content.trim()===""){
                            comment_place.val("")
                            comment_place.attr({"placeholder":"评论内容不能为空哦"})
                        }else{
                            t.html("发表中···")
                            response.append("comment",t.siblings("textarea").val())
                            response.append("video_id",t.data().videoId)
                            $.ajax({
                                url:"/add_video_comment/",
                                type:"POST",
                                data:response,
                                contentType:false,
                                processData:false,
                                success:function(data){
                                    if(data.code==200){
                                        //发表成功
                                        page=1
                                        compileComment(page)
                                    }else if(data.code==302){
                                         //跳转登录页面
                                         location.replace('/login/?next=/#1')
                                    }else{
                                        //未处理状态
                                        return
                                    }
                                },
                                error:function(){
                                    //网络错误
                                    return
                                }
                            })
                        }
                    })
                },
                error:function(e){
                    //网络接口错误
                }
            })
        }
        compileComment(page_local)

        var oContainer = document.getElementById("video_list_container"),
                oDiv1 = document.getElementById("div1"),
                oDiv2 = document.getElementById("div2"),
                oDiv3 = document.getElementById("div3");

        oDiv3.onmousedown = function (e) {
            e = e || event;

            var disY = e.clientY - this.offsetTop;

            if (oDiv3.setCapture) {
                oDiv3.onmousemove = fnMove;
                oDiv3.onmouseup = fnUp;
                oDiv3.setCapture();
            } else {
                document.onmousemove = fnMove;
                document.onmouseup = fnUp;
            }

            function fnMove(ev) {
                ev = ev || event;

                var t = ev.clientY - disY;
                setTop(t);
            };

            function fnUp() {
                this.onmousemove = null;
                this.onmouseup = null;

                if (this.releaseCapture) {
                    this.releaseCapture();
                }
            };

            return false;
        };
        function bindTouchLink(){
            window.open($(this).parent()[0].href)
        }
        let touchBtns = $(".video_list_item_content")
        touchBtns.on("touchend",bindTouchLink)
        oDiv3.ontouchstart = function(e){
            e = e.touches[0];

            var disY = e.clientY - oDiv3.offsetTop;

            if (oDiv3.setCapture) {
                oDiv3.ontouchmove = fnMove;
                oDiv3.ontouchend = fnUp;
                oDiv3.setCapture();
            } else {
                document.ontouchmove = fnMove;
                document.ontouchend = fnUp;
            }

            function fnMove(ev) {
                ev = ev.touches[0];
                var t = ev.clientY - disY;
                setTop(t);
            };

            function fnUp() {
                this.ontouchmove = null;
                this.ontouchend = null;

                if (this.releaseCapture) {
                    this.releaseCapture();
                }
            };
            return false;
        }

        function setTop(t) {
            var down = oDiv2.offsetHeight - oDiv3.offsetHeight;

            if (t < 0) {
                t = 0;
            } else if (t > down) {
                t = down
            }

            oDiv3.style.top = t + 'px';

            var scale = t / down;
            oDiv1.style.top = -(oDiv1.offsetHeight - oContainer.offsetHeight) * scale + 'px';
        }

        addEvent(oDiv1, 'mousewheel', mousewheel);
        addEvent(oDiv1, 'DOMMouseScroll', mousewheel);
        addEvent(oDiv2, 'mousewheel', mousewheel);
        addEvent(oDiv2, 'DOMMouseScroll', mousewheel);

        function addEvent(obj, oEvent, fn) {
            if (obj.attachEvent) {
                obj.attachEvent('on' + oEvent, fn);
            } else {
                obj.addEventListener(oEvent, fn, false);
            }
        }

        function mousewheel(e) {
            var ev = e || event,
                    bDown = false;

            bDown = ev.wheelDelta ? ev.wheelDelta < 0 : ev.detail > 0;

            if (bDown) {
                setTop(oDiv3.offsetTop + oDiv2.clientHeight / oDiv1.clientHeight * 80);
            } else {
                setTop(oDiv3.offsetTop - oDiv2.clientHeight / oDiv1.clientHeight * 80);
            }

            //FF,绑定事件，阻止默认事件
            if (e.preventDefault) {
                e.preventDefault();
            }

            return false;
        }
        if (oDiv1.clientHeight < 512*sizeParam) {
            $(oDiv2).hide()
        }

        //底部菜单切换逻辑
        $('.title_container').click(function(e){
            let t =$(e.target)
            let animatedCount=$(".main_container").find("div:animated").length
            let toggleClass=function(){
                if(t.hasClass('title_active')){
                    return
                }else{
                    $(".title_active").removeClass('title_active')
                    t.addClass('title_active')
                }
            }
            let toggleContainer=function(selector){
                //css("display","none")
                //$(selector).show("slow").siblings().not(".title_container").hide("slow")
                $(selector).siblings(":visible").not(".title_container").animate({opacity:"0"},300,function(e){
                    $(selector).siblings().not(".title_container").hide()
                    $(selector).show().css("opacity",0)
                     $(selector).animate({opacity:"1"},300)
                })
                //$(selector).siblings().not(".title_container").hide()
            }
            switch(t.text().trim()){
                case "本期要点":
                if(animatedCount==0){
                    toggleClass()
                    toggleContainer('.point_container')
                }else{
                    return
                }
                break;
                case "课程目录":
                if(animatedCount==0){
                    toggleClass()
                    toggleContainer('.study_list_container')
                }else{
                    return
                }
                break;
                case "讲者介绍":
                if(animatedCount==0){
                    toggleClass()
                    toggleContainer('.introduce_container')
                }else{
                    return
                }
                break;
                case "评论":
                if(animatedCount==0){
                    toggleClass()
                    toggleContainer('.comment_container')
                }else{
                    return
                }
                break;
                case "资料下载":
                if(animatedCount==0){
                    toggleClass()
                    toggleContainer('.download_container')
                }else{
                    return
                }
                break;
            }
        })
        //视频列表的视频时间与视频状态切换逻辑
        $(".video_block").mouseenter(function (e) {
            let t = $(this)
            t.siblings().find(".video_state").hide()
            t.find(".video_state").show()
        }).mouseleave(function (e) {
            $(this).find(".video_state").hide()
        })

         $('.video_list_button').click(function(){
            let t =$(this)
            t.toggleClass("video_list_button_open")
            $("#video_list_container").toggleClass("video_list_open")
            t.find("img").toggleClass("rotate_img")
        })

        // 购买浮层
        let bill_container=$(".bill_background")
        $(".bill_container_cancel").click(function(){
            bill_container.addClass("hide")
        })
        $(".bill_cancel").click(function(){
            bill_container.addClass("hide")
        })

        let readmeButton=$(".checkbox_container")
        readmeButton.click(function(){
            readmeButton.find('img').toggleClass('hide')
        })
        //按钮事件
        let bill_confirm=$(".bill_confirm")
        let bill_cancel=$(".bill_cancel")
        // bill_confirm.on("mousedown",function(){
        //     bill_confirm.addClass("bill_button_click")
        // })
        // bill_confirm.on("mouseup  mouseout",function(){
        //     bill_confirm.removeClass("bill_button_click")
        // })
        // bill_cancel.on("mousedown",function(){
        //     bill_cancel.addClass("bill_button_click")
        // })
        // bill_cancel.on("mouseup mouseout",function(){
        //     bill_cancel.removeClass("bill_button_click")
        // })
        //医咖会协议
        let readme=$(".readme")
        let readme_cancel=$(".readme_cancel")
        $(".readme_show").click(function(){
            readme.removeClass("hide")
        })
        readme_cancel.click(function(){

            readme.addClass("hide")
        })
        //点击购买
        let course_purchase=$(".charge")
        course_purchase.click(function(){
            if({{ front_user.id|default:0 }}){
                bill_container.removeClass("hide")
            }else{
                location.replace('/login/?next='+window.location.pathname+'#1')
            }
        })
        //提交订单
        bill_confirm.click(function(){
            if($(".checkbox_container").find(".checkbox_confirm:visible").length==1){
                location.href='/front_create_orders/'
                sessionStorage.setItem('type','post')
                sessionStorage.setItem('course_id',course_purchase.data().id)
                sessionStorage.setItem('course_price',$('.price_new').html())
                sessionStorage.setItem('order_id_used',"")
                sessionStorage.setItem('page_from',location.pathname)
            }else{
                //未同意协议
                return
            }


        })
    </script>
{% endblock bodyblock %}